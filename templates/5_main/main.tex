\chapter{Теоретичні відомості}

Вивчайте \TeX \cite{Knuth:1984}.
?

\section{Постановка задачі}
\subsection{Задача}
Визначення проблеми ректифікації зображень полягає у проєктуванні  цих зображень 
на компланарні площини. Так, щоб епіполярні лінії стали горизонтальними.
Паралельними до прямої, що з'єднує центрі камер.
\subsection{Попередні роботи}
В даній роботі ми ректифікуємо зображення за допомогою матриці гомографії. 
Основні попередні роботи зі схожим алгоритмом: 
\href{https://users.cecs.anu.edu.au/~hartley/Papers/joint-epipolar/journal/joint3.pdf}
{метод Hartley}, 
\href{https://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.97.7214&rep=rep1&type=pdf}
{метод Малона}. Перший метод знаходить гомографію вирішуючи оптимізаційні 
задачі. Другий знаходить трохи іншу матрицю перетворення, але так само --- 
оптимізаційними задачами. Наш запропонованій метод шукає гомографію векторним 
добутком, а оптимізаційну задачу вирішує лише для одної координати.


\section{Теоретичні передумови}
\subsection{Епіполярна геометрія}
Коли дві камери розглядають 3D-сцену з двох різних позицій, існує ряд 
геометричних співвідношень між 3D-точками та їх проєкціями на 2D-зображення, 
що визначають пошук можливих положень точок зображення. Ці співвідношення 
виводяться на основі припущення, що камери можуть бути апроксимовані 
моделлю \href{https://en.wikipedia.org/wiki/Camera_obscura}{камери-обскури}. 
Їх і вивчає епіполярна геометрія. 
\\
\indent
Застосування принципів епіполярної геометрії зазвичай мотивовано пошуком
відповідних точок 
\href{https://uk.wikipedia.org/wiki/%D0%A1%D1%82%D0%B5%D1%80%D0%B5%D0%BE%D0%BF%D0%B0%D1%80%D0%B0}
{стереопари}. Нехай точка $X$ в 3х вимірному просторі проектується на два 
зображення. В точку $x$ на першому та в точку $x'$ на другому. Який зв'язок 
між відповідними $x$ та $x'$? $X, x, x'$ та центри камер 
\href{https://en.wikipedia.org/wiki/Coplanarity}{компланарні}. Назвемо цю 
площину $\pi$. Звісно промені з $x$ та $x'$, які перетинають $X$ також належать
$\pi$. Саме ця властивість є найважливішою для подальшого пошуку відповідностей.
\\\indent
Нехай ми знаємо тільки $x$, давайте побудуємо відповідну їй $x'$. Знайдемо 
площину $\pi$ з центрів камер та проміня $x$. З зазначеного вище $x'$ лежить на 
$l'$ --- прямій перетину $\pi$ з площиною другого зображення. Ця пряма 
називається епіполярною прямою $x$. Тепер, щоб знайти $x'$ нам достатньо 
перевірити $l'$, а не повністю все друге зображення.
\begin{itemize}
	\item{Епіполярна точка чи епіполь --- точка перетину другого зображення
з лінією, яка перетинає центри камер (проекція центру другої камери на перше 
зображення)}
    \item{Епіполярна площина --- площина, що вміщує пряму, яка перетинає центри 
камер та певну точку (параметр), яка проектується на зображення.
зображення. }
    \item{Епіполярна пряма --- перетин епіполярної площини з зображенням. Всі
епіполярні лінії перетинаються в епіполі. Епіполярна полощина перетинає перше 
та друге зображення та визначає віповідність між їх епіполярними лініями.}
\end{itemize}

\subsection{Ректифікація зображення}
\href{https://en.wikipedia.org/wiki/Image_rectification}{Ректифікація зображень} 
проектує зображення на одну спільну площину (копланарні площини). Ректифікація 
використовується в комп'ютерному баченні для пошуку відповідних точок між 
зображеннями. Нехай ми маємо два або більше зображень з відомим розташуванням 
центр камер, які показують об'єкт з різних ракурсів. Для кожного пікселя на 
одному зображенні ми знаходимо відповідний на іншому. Далі за допомогою 
\href{https://en.wikipedia.org/wiki/Triangulation_(computer_vision)}
{триангуляції} визначаємо їх глибини. 
\\
\indent
За епіполярною геометрією: відповідний піксель може знаходитися тільки на 
епіполярній лінії. Ректифікація трансформує вхідні зображення так, наче вони 
були зроблені тільки з горизонтальним зміщенням. Як наслідок: всі епіполярні 
лінії --- горизонтальні (паралельні прямій, що з'єднує центрі камер). Це 
набагато спрощує процес пошуку відповідних пікселів. 
\\
\indent
Ректифіковані зображення мають такі властивості:
\begin{itemize}
 \item{Всі епіполярні лінії паралельні до горизонтальної осі}
 \item{Відповідні точки зображень мають однакові вертикальні координати}
\end{itemize}

\subsection{Фундаментальна матриця}
Фундаментальна матриця $F \in \mathbb{R}^{3\times3}$ дає алгебраїчну 
характеристику епіполярній геометрії. Вона визначає співвідношення між точкою 
$x$ і відповідною епіполярною лінією $l'$. Якщо у нас є два зображення, центри 
камер яких не збігаються, тоді існує така унікальна матриця $F$, що 
задовольняє ${x'}^T \cdot F \cdot x = 0$ для всіх співвідносних $x$ та $x'$.
\\
\indent
Фундаментальна матриця $F$ може бути записана як $F = {[e']}_\times H_\pi$, де 
$\pi$ --- епіполярна площина $X$, $e'$ --- епіполь, а $H_\pi$ --- перетворення з
одного зображення в інше через будь яку площину $\pi$. Оскільки 
$\operatorname{rank}({[e']}_\times) = 2$, а $\operatorname{rank}(H_\pi) = 3$,
то $\operatorname{rank}(F) = 2$ 

\subsection{Гомографія}



\section{Алгоритм}
\subsection{План}
\begin{enumerate}
   \item Знайти фундаментальну матрицю зображень
   \begin{itemize}
     \item{Визначити ключові точки для кожного зображення}
     \item{Співставити ключові точки правого та лівого зображень}
     \item{Знайти фундаментальну матрицю}
   \end{itemize}
   \item Стерео ректифікувати зображення 
   \begin{itemize}
     \item{Епіполярна точка}
     \item{Перетворення правого зображення}
     \item{Перетворення лівого зображення}
   \end{itemize}
\end{enumerate}

\subsection{Пошук фундаментальної матриці}
\subsubsection{Ключові точки}
Ключові точкі --- це характерні точкі зображення, ознаки, які 
максимально точно описують його. Є різні алгоритми вилучення ключових точок:
\href{https://en.wikipedia.org/wiki/Scale-invariant_feature_transform}{SIFT},
\href{https://en.wikipedia.org/wiki/Speeded_up_robust_features}{SURF},
\href{https://ieeexplore.ieee.org/abstract/document/6126544}{ORB}. Ми 
використовуємо традиційний SIFT алгоритм.

\subsubsection{Співставлення ключових точок}
Ми знайшли ключові точки окремо для кожного зображення. Оскільки вони зроблені з
різних перспектив, то знайдені точки будуть різними. Для подальшого знаходження 
фундаментальної матриці зображень треба співставити ці точки. Це дозволить 
зрозуміти, які з них присутні на обох зображеннях та різницю в їх росташуванні. \\
Ми використовуємо алгоритм співставлення 
\href{https://github.com/flann-lib/flann}{Флана}. Він сортує найкращі потенційні
співставлення за відстанню використовуючи 
\href{https://en.wikipedia.org/wiki/K-nearest_neighbors_algorithm}{KNN} пошук.

\subsubsection{Фундаментальна матриця}
\href{https://en.wikipedia.org/wiki/Fundamental_matrix_(computer_vision)}
{Фундаментальна матриця} --- описує відношення між відповідними точками 
зображень (раніше співставленні ключові точки). Співпоставляє точки на лівому? 
зображенні з прямими на правому? зображенні. Є різні методи, щоб досягти цого:
Seven-Point,
\href{https://en.wikipedia.org/wiki/Eight-point_algorithm}{Eight-Point},
least-median Seven-Point,
\href{https://en.wikipedia.org/wiki/Random_sample_consensus}{RANSAC} алгоритми.
Ми використовуємо least-median Seven-Point алгоритм.


\subsection{Стерео ректифікація}
\subsubsection{Епіполярна точка}
\href{https://en.wikipedia.org/wiki/Epipolar_geometry}
{Епіполярні точки} --- точки проекцій кожного оптичного центру на площину 
зображення іншої камери. Виходить, що епіполі та оптичні центри лежать на одній 
прямій. Ми шукаємо праву епіполь і саме тому почнемо з перетворення правого 
зображення. \\
Оскільки нам потрібна саме права епіполярна точна (праве ядро фундаментальної 
матриці), транспонуємо фундаментальну матрицю $F \in \mathbb{R}^{3\times3}$. 
Далі знаходимо ортонормований базис нульвого простору отриманної матриці. За 
допомогою алгоритма 
\href{https://en.wikipedia.org/wiki/Singular_value_decomposition}
{SVD}. Залишилося тільки пронормувати отриману епіполярну точку. В даній роботі
ми нормуємо по останній координаті так, що епіполь має такий вигляд 
\begin{equation}
e' = {
\begin{bmatrix}
\frac{{{e'}_n}_x}{{{e'}_n}_z} & \frac{{{e'}_n}_y}{{{e'}_n}_z} & 
\frac{{{e'}_n}_z}{{{e'}_n}_z}
\end{bmatrix}
}^T = {
\begin{bmatrix}
e'_x & e'_y & 1
\end{bmatrix}
}^T.
\end{equation}
У вигляді кососиметричної матриці для векторного добутку
\begin{equation}
{[e']}_\times \:\:\: = \:\:\:
\left[
\begin{matrix}
0 & -{e'}_z & {e'}_y\\
{e'}_z & 0 & -{e'}_x\\
-{e'}_y & {e'}_x & 0\
\end{matrix}
\right].
\end{equation}

\subsubsection{Перетворення правого зображення}
Знайдемо таку $R_r$, що переносить праву епіполярну точку на нескінченність 
\begin{equation}
	R_r \cdot e' = {[f_r \:\:\: 0 \:\:\: 0]}^T.
\end{equation}
Вона має вигляд 
\begin{equation}
	R_r = T^{-1} \cdot G \cdot R \cdot T,
\end{equation}
де $T$ --- переміщення центра зображення, $R$ --- занулення Y координати 
(матриця повороту), $G$ --- занулення Z координати.
\\\\
Знайдемо матрицю переміщення $T$ та її обернену $T^{-1}$
\begin{equation}
T \:\:\: = \:\:\:\left[
\begin{matrix}
1 & 0 & -c_x\\
0 & 1 & -c_y\\
0 & 0 & 1\
\end{matrix}
\right]
\:\:\:\:\:\:\:\:\:
T^{-1} \:\:\: = \:\:\:\left[
\begin{matrix}
1 & 0 & c_x\\
0 & 1 & c_y\\
0 & 0 & 1\
\end{matrix}
\right],
\end{equation}
де $c_x = \frac{w}{2}; \:\:\: c_y = \frac{h}{2}$, а $w$ і $h$ --- розміри 
правого зображення.
\\
\indent
При переміщенні центру 
зображення ми перемістили і епіполярну точку зображення. Тому перед
початком подальших розрахунків, повернемо її на місце
\begin{equation}
	{e'}_t = T \cdot e'.
\end{equation}
Також введемо $k = {[0, 0, 1]}^T$, де знаходится центр нашого правого 
зображення.
\\\\
\indent
Знайдемо матрицю повороту R, яка занулить Y координату епіполярної точки. 
Останню координату не будемо чіпати, другу зануляємо і нормуємо (матриця  
повороту R --- ортонормована). Перша --- їх нормований векторний добуток 
(матриця повороту --- правий базис). Отримали
\begin{equation}
R \:\:\: = \:\:\:\left[
\begin{matrix}
\frac{{(k \times ({e'}_t \times k))}^T} 
{\left \| (k \times ({e'}_t \times k)) \right \|}\\
\frac{{(k \times {e'}_t)}^T}{\left \| (k \times {e'}_t) \right \|}\\
k^T\
\end{matrix}
\right].
\end{equation}
\\\\
Знайдемо матрицю G. Вона повинна занулити Z координату епіполярної
точки і перемістити її на нескінченність
\begin{equation}
G \:\:\: = \:\:\:\left[
\begin{matrix}
1 & 0 & 0\\
0 & 1 & 0\\
\frac{-1}{{(R \cdot {e'}_t)}_x} & 0 & 1\
\end{matrix}
\right].
\end{equation}
\\\\
Підставимо всі отримані результати
\begin{equation}
\begin{array}{l}
R_r  \:\:\: = \:\:\: T^{-1} \cdot \:\:\: G \cdot R \:\:\: \cdot T \:\:\: = 
\\\\
= \:\:\:
\left[
\begin{matrix}
1 & 0 & cx\\
0 & 1 & cy\\
0 & 0 & 1\
\end{matrix}
\right]
\cdot
\left[
\begin{matrix}
1 & 0 & 0\\
0 & 1 & 0\\
\frac{-1}{{(R \cdot {e'}_t)}_x} & 0 & 1\
\end{matrix}
\right]
\cdot
\left[
\begin{matrix}
\frac{{(k \times ({e'}_t \times k))}^T} 
{\left \| (k \times ({e'}_t \times k)) \right \|}\\
\frac{{(k \times {e'}_t)}^T}{\left \| (k \times {e'}_t) \right \|}\\
k^T\
\end{matrix}
\right]
\cdot
\left[
\begin{matrix}
1 & 0 & -cx\\
0 & 1 & -cy\\
0 & 0 & 1\
\end{matrix}
\right] \:\:\: =
\\\\
= \:\:\:
\left[
\begin{matrix}
1 & 0 & cx\\
0 & 1 & cy\\
0 & 0 & 1\
\end{matrix}
\right]
\cdot
\left[
\begin{matrix}
\frac{{(k \times ({e'}_t \times k))}^T} 
{\left \| (k \times ({e'}_t \times k)) \right \|}\\
\frac{{(k \times {e'}_t)}^T}{\left \| (k \times {e'}_t) \right \|}\\
k^T-\frac{{(k \times ({e'}_t \times k))}^T} 
{\left \| (k \times ({e'}_t \times k)) \right \| \cdot {(R \cdot {e'}_t)}_x}\
\end{matrix}
\right]
\cdot
\left[
\begin{matrix}
1 & 0 & -cx\\
0 & 1 & -cy\\
0 & 0 & 1\
\end{matrix}
\right].
\end{array}
\end{equation}
Таким чином ми знайшли $R_r$, що задовольняє 1.3.
\\
\indent

\subsubsection{Перетворення лівого зображення}
Знайдемо таку $R_l$, що переносить ліву епіполярну точку на нескінченність. 
Нехай $R_l = A \cdot M'$, де $A$ --- матриця з параметрами, а $M'$ --- має ранг 
3.
\\\\
\indent
Візьмемо фундаментальну матрицю $F$ і з її допомогою зіставимо епіполярні лінії
лівого зображення до епіполярних ліній правого ${[{e'}_t]}_\times \cdot F$. 
Далі застосуємо на них знайомий алгоритм для перетворення правого зображення. 
Результат назвемо матрицею $M = R_r \cdot {[{e'}_t]}_\times \cdot F$. Отримаємо
\begin{equation}
M \:\:\: = \:\:\: R_r \cdot {[{e'}_t]}_\times \cdot F \:\:\: = \:\:\:
\left[
\begin{matrix}
\frac{{({e'}_t \times k)}^T}
{\left \| ({e'}_t \times k) \right \|}\\
\frac{{(k \times ({e'}_t \times k))}^T}
{\left \| (k \times ({e'}_t \times k)) \right \|} 
- \left \| (k \times ({e'}_t \times k)) \right \| \cdot k^T\\
(1 + \frac{1}{{\left \| (k \times ({e'}_t \times k)) \right \|}^2}) \cdot {(k \times {e'}_t)}^T\
\end{matrix}
\right]
\cdot F.
\end{equation}
Бачимо, що $\operatorname{rank}(M) = 2$. $M_x$ та $M_z$ колінеарні, 
коли $M_x$ та $M_z$ отрогональні.
\\\\
\indent
Створимо нову матрицю $M'$ на основі матриці $M$, щоб 
$\operatorname{rank}(M) = 3$. Другу та третю координати залишимо без 
змін, першу? ж координату змінемо на векторний добуток двох інших. 
Отримаємо
\begin{equation}
    M' =
    \left[
    \begin{matrix}
    M_y \times M_z\\
    M_y\\
    M_z\
    \end{matrix}
    \right].
\end{equation}
Ми збільшили ранг, але втратили властивість ректифікації (переносу 
лівої епіполі
на нескінченність).???
\\\\
\indent
Введемо матрицю 
\begin{equation}
    A =
    \left[
    \begin{matrix}
    a & b & c\\
    0 & 1 & 0\\
    0 & 0 & 1\
    \end{matrix}
    \right],
\end{equation}
щоб знайти $R_l$. Залишилося вирішити оптимізаційну задачу та знайти параметри 
$a, b, c$ методом найменших квадратів.  











\section{Аналіз алгоритму}
?